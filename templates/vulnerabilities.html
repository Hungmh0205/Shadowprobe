<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vulnerabilities - ShadowProbe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-100 min-h-screen">
  <aside class="fixed top-0 left-0 h-screen w-64 bg-gray-900 text-white flex flex-col z-40">
    <div class="h-20 flex items-center justify-center border-b border-gray-800">
      <span class="text-2xl font-bold tracking-wide">ShadowProbe</span>
    </div>
    <nav class="flex-1 py-6">
      <ul class="space-y-1">
        <li>
          <a href="/dashboard" class="flex items-center px-6 py-3 hover:bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
          </a>
        </li>
        <li>
          <a href="/" class="flex items-center px-6 py-3 hover:bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-globe mr-3"></i> Websites
          </a>
        </li>
        <li>
          <a href="/scans" class="flex items-center px-6 py-3 hover:bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-search mr-3"></i> Scans
          </a>
        </li>
        <li>
          <a href="/vulnerabilities" class="flex items-center px-6 py-3 bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-shield-alt mr-3"></i> Vulnerabilities
          </a>
        </li>
        <li>
          <a href="#" class="flex items-center px-6 py-3 hover:bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-desktop mr-3"></i> Monitors
          </a>
        </li>
        <li>
          <a href="/reports" class="flex items-center px-6 py-3 hover:bg-gray-800 rounded-r-full font-medium">
            <i class="fas fa-file-alt mr-3"></i> Reports
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="ml-64 flex-1 flex flex-col">
    <header class="h-20 bg-white flex items-center px-8 border-b border-gray-200">
      <h1 class="text-2xl font-bold text-gray-900">Vulnerabilities</h1>
    </header>

    <main class="flex-1 p-10 bg-gray-100">
      <!-- Filter/Tab Section -->
      <div class="mb-8">
        <!-- Tabs -->
        <div class="flex space-x-8 border-b border-gray-200 mb-6">
          <button id="tab-open" class="pb-3 text-blue-600 font-semibold border-b-2 border-blue-600 focus:outline-none">
            Open (<span id="count-open">0</span>)
          </button>
          <button id="tab-fixed" class="pb-3 text-gray-500 font-semibold border-b-2 border-transparent hover:text-blue-600 hover:border-blue-200 focus:outline-none">
            Fixed (<span id="count-fixed">0</span>)
          </button>
          <button id="tab-false-positive" class="pb-3 text-gray-500 font-semibold border-b-2 border-transparent hover:text-blue-600 hover:border-blue-200 focus:outline-none">
            False Positive (<span id="count-false-positive">0</span>)
          </button>
          <button id="tab-wont-fix" class="pb-3 text-gray-500 font-semibold border-b-2 border-transparent hover:text-blue-600 hover:border-blue-200 focus:outline-none">
            Won't Fix (<span id="count-wont-fix">0</span>)
          </button>
        </div>

        <!-- Filters -->
        <div class="flex items-center space-x-4 mb-6">
          <div class="flex flex-col">
            <label class="text-xs text-gray-500 mb-1">Website</label>
            <select id="filter-website" class="border border-gray-200 rounded px-4 py-2 text-gray-700 focus:ring-2 focus:ring-blue-500 min-w-[160px]">
              <option value="">--</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label class="text-xs text-gray-500 mb-1">CVSS Score</label>
            <select id="filter-cvss" class="border border-gray-200 rounded px-4 py-2 text-gray-700 focus:ring-2 focus:ring-blue-500 min-w-[160px]">
              <option value="">--</option>
              <option value="critical">Critical (9.0-10.0)</option>
              <option value="high">High (7.0-8.9)</option>
              <option value="medium">Medium (4.0-6.9)</option>
              <option value="low">Low (0.1-3.9)</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label class="text-xs text-gray-500 mb-1">Severity</label>
            <select id="filter-severity" class="border border-gray-200 rounded px-4 py-2 text-gray-700 focus:ring-2 focus:ring-blue-500 min-w-[160px]">
              <option value="">--</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
              <option value="info">Info</option>
            </select>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-xs text-gray-500 mb-1">Search</label>
            <input type="text" id="search-vulns" placeholder="Search" class="border border-gray-200 rounded px-4 py-2 text-gray-700 focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div id="vuln-content">
        <!-- Empty State -->
        <div id="empty-state" class="flex flex-col items-center justify-center py-24">
          <div class="relative mb-6">
            <!-- Browser window with sad face -->
            <svg width="96" height="96" fill="none" viewBox="0 0 96 96" class="opacity-80">
              <!-- Browser window -->
              <rect x="8" y="8" width="80" height="80" rx="8" fill="#F3F4F6" stroke="#E5E7EB" stroke-width="2"/>
              <!-- Browser tabs -->
              <rect x="12" y="12" width="24" height="8" rx="4" fill="#E5E7EB"/>
              <rect x="40" y="12" width="16" height="8" rx="4" fill="#E5E7EB"/>
              <rect x="60" y="12" width="16" height="8" rx="4" fill="#E5E7EB"/>
              <!-- Browser controls -->
              <circle cx="20" cy="16" r="2" fill="#D1D5DB"/>
              <circle cx="28" cy="16" r="2" fill="#D1D5DB"/>
              <circle cx="36" cy="16" r="2" fill="#D1D5DB"/>
              <!-- Content area -->
              <rect x="12" y="24" width="72" height="56" rx="4" fill="#FFFFFF"/>
              <!-- Sad face -->
              <circle cx="36" cy="40" r="3" fill="#D1D5DB"/>
              <circle cx="60" cy="40" r="3" fill="#D1D5DB"/>
              <path d="M 36 52 Q 48 58 60 52" stroke="#D1D5DB" stroke-width="2" fill="none"/>
            </svg>
            <!-- Broken connection lines -->
            <div class="absolute -top-2 -right-2">
              <div class="w-4 h-0.5 bg-gray-400 transform rotate-45 mb-1"></div>
              <div class="w-4 h-0.5 bg-gray-400 transform -rotate-45"></div>
            </div>
          </div>
          <div class="text-gray-400 text-lg mb-4">There aren't any results for that query.</div>
          <button id="scan-now-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded font-semibold shadow">Scan Now</button>
        </div>

        <!-- Results Table (hidden by default) -->
        <div id="results-table" class="hidden">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vulnerability</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVSS</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="vuln-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Results will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Tab switching
    const tabs = ['open', 'fixed', 'false-positive', 'wont-fix'];
    const tabButtons = tabs.map(id => document.getElementById(`tab-${id}`));
    
    tabButtons.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        // Remove active state from all tabs
        tabButtons.forEach(b => {
          b.classList.remove('text-blue-600', 'border-blue-600');
          b.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Add active state to clicked tab
        btn.classList.remove('text-gray-500', 'border-transparent');
        btn.classList.add('text-blue-600', 'border-blue-600');
        
        // Load data for selected tab
        loadVulnerabilities(tabs[index]);
      });
    });

    // Filter change handlers
    document.getElementById('filter-website').addEventListener('change', applyFilters);
    document.getElementById('filter-cvss').addEventListener('change', applyFilters);
    document.getElementById('filter-severity').addEventListener('change', applyFilters);
    document.getElementById('search-vulns').addEventListener('input', applyFilters);

                // Scan Now button
            document.getElementById('scan-now-btn').addEventListener('click', () => {
              // Redirect to scans page with parameter to open modal and set scan type to vulnerability
              window.location.href = '/scans?newscan=1&scanType=vulnerability';
            });

    // Load websites for filter
    async function loadWebsites() {
      try {
        const response = await fetch('/api/websites');
        const data = await response.json();
        const select = document.getElementById('filter-website');
        
        data.websites.forEach(website => {
          const option = document.createElement('option');
          option.value = website.id;
          option.textContent = website.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load websites:', error);
      }
    }

    // Load vulnerabilities
    async function loadVulnerabilities(status = 'open') {
      try {
        const response = await fetch(`/api/vulnerabilities?status=${status}`);
        const data = await response.json();
        
        updateCounts(data.counts);
        displayResults(data.vulnerabilities);
      } catch (error) {
        console.error('Failed to load vulnerabilities:', error);
        showEmptyState();
      }
    }

    // Update counts
    function updateCounts(counts) {
      document.getElementById('count-open').textContent = counts.open || 0;
      document.getElementById('count-fixed').textContent = counts.fixed || 0;
      document.getElementById('count-false-positive').textContent = counts.false_positive || 0;
      document.getElementById('count-wont-fix').textContent = counts.wont_fix || 0;
    }

    // Display results
    function displayResults(vulnerabilities) {
      const emptyState = document.getElementById('empty-state');
      const resultsTable = document.getElementById('results-table');
      const tbody = document.getElementById('vuln-tbody');

      if (!vulnerabilities || vulnerabilities.length === 0) {
        showEmptyState();
        return;
      }

      // Hide empty state, show table
      emptyState.classList.add('hidden');
      resultsTable.classList.remove('hidden');

      // Clear existing rows
      tbody.innerHTML = '';

      // Add new rows
      vulnerabilities.forEach(vuln => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const severityColor = getSeverityColor(vuln.severity);
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${escapeHtml(vuln.title)}</div>
            <div class="text-sm text-gray-500">${escapeHtml(vuln.owasp || '')}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(vuln.website_name)}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${severityColor.bg} ${severityColor.text}">
              ${vuln.severity.toUpperCase()}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${vuln.cvss_score || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
              ${vuln.status.toUpperCase()}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(vuln.created_at)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="text-blue-600 hover:text-blue-900 mr-3">View</button>
            <button class="text-green-600 hover:text-green-900 mr-3">Fix</button>
            <button class="text-red-600 hover:text-red-900">Delete</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Show empty state
    function showEmptyState() {
      document.getElementById('empty-state').classList.remove('hidden');
      document.getElementById('results-table').classList.add('hidden');
    }

    // Apply filters
    function applyFilters() {
      const website = document.getElementById('filter-website').value;
      const cvss = document.getElementById('filter-cvss').value;
      const severity = document.getElementById('filter-severity').value;
      const search = document.getElementById('search-vulns').value;

      // Get current active tab
      const activeTab = tabs.find(tab => 
        document.getElementById(`tab-${tab}`).classList.contains('text-blue-600')
      ) || 'open';

      // Reload with filters
      loadVulnerabilitiesWithFilters(activeTab, { website, cvss, severity, search });
    }

    // Load vulnerabilities with filters
    async function loadVulnerabilitiesWithFilters(status, filters) {
      try {
        const params = new URLSearchParams({ status, ...filters });
        const response = await fetch(`/api/vulnerabilities?${params}`);
        const data = await response.json();
        
        updateCounts(data.counts);
        displayResults(data.vulnerabilities);
      } catch (error) {
        console.error('Failed to load vulnerabilities with filters:', error);
        showEmptyState();
      }
    }

    // Helper functions
    function getSeverityColor(severity) {
      const colors = {
        critical: { bg: 'bg-red-100', text: 'text-red-800' },
        high: { bg: 'bg-orange-100', text: 'text-orange-800' },
        medium: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
        low: { bg: 'bg-green-100', text: 'text-green-800' },
        info: { bg: 'bg-blue-100', text: 'text-blue-800' }
      };
      return colors[severity] || colors.info;
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        return new Date(dateString).toLocaleDateString();
      } catch {
        return 'N/A';
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      loadWebsites();
      loadVulnerabilities('open');
    });
  </script>
</body>
</html>
